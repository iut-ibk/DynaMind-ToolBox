INCLUDE(InstallRequiredSystemLibraries)

SET(CPACK_NSIS_DISPLAY_NAME "DynaMind-Toolbox")
SET(CPACK_PACKAGE_DESCRIPTION_SUMMARY "DynaMind-Toolbox")
SET(CPACK_PACKAGE_NAME "DynaMind-Toolbox_with_Python")
SET(CPACK_PACKAGE_VENDOR "University of Innsbruck")
SET(CPACK_PACKAGE_VERSION_MAJOR "0")
SET(CPACK_PACKAGE_VERSION_MINOR "3")
SET(CPACK_PACKAGE_VERSION_PATCH "0")
SET(CPACK_RESOURCE_FILE_LICENSE "${DynaMind-ToolBox_SOURCE_DIR}/LICENSE")


IF(WIN32 AND NOT UNIX)
    SET(CPACK_NSIS_DISPLAY_NAME "DynaMind-Toolbox")
    SET(CPACK_NSIS_HELP_LINK "http:\\\\\\\\www.dynamind-toolbox.org")
    SET(CPACK_NSIS_URL_INFO_ABOUT "http:\\\\\\\\www.dynamind-toolbox.org")
    SET(CPACK_NSIS_CONTACT "christian.urich@gmail.com")

    SET(CPACK_NSIS_EXTRA_INSTALL_COMMANDS "
        !include \\\"winmessages.nsh\\\"
        !define env_hklm 'HKLM \\\"SYSTEM\\\\CurrentControlSet\\\\Control\\\\Session Manager\\\\Environment\\\"'
        !define env_hkcu 'HKCU \\\"Environment\\\"'
        WriteRegExpandStr  \\\${env_hklm} DYNAMIND_DIR $INSTDIR
        SendMessage \\\${HWND_BROADCAST} \\\${WM_WININICHANGE} 0 \\\"STR:Environment\\\" /TIMEOUT=5000
        WriteRegExpandStr  \\\${env_hklm} DYNAMIND_PYTHON $INSTDIR\\\\lib
        SendMessage \\\${HWND_BROADCAST} \\\${WM_WININICHANGE} 0 \\\"STR:Environment\\\" /TIMEOUT=5000
        ClearErrors
        ")
        FILE(GLOB DLLS
              ${QT_BINARY_DIR}/QtCore4.dll
              ${QT_BINARY_DIR}/QtGui4.dll
              ${QT_BINARY_DIR}/QtXml4.dll
              ${QT_BINARY_DIR}/QtXmlPatterns4.dll
              ${QT_BINARY_DIR}/QtNetwork4.dll
              ${QT_BINARY_DIR}/QtWebKit4.dll
              ${QT_BINARY_DIR}/phonon4.dll
              ${QT_BINARY_DIR}/QtOpenGL4.dll
              ${QT_BINARY_DIR}/QtSVG4.dll
              ${QT_BINARY_DIR}/QtSql4.dll
              ${CGAL_DIR}/bin/CGAL-vc90-mt-4.0.2.dll
              ${QGLVIEWER_INCLUDE_DIR}/QGLViewer/release/QGLViewer2.dll
              ${Boost_LIBRARY_DIRS}/boost_python-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_thread-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_chrono-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_graph-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_system-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_signals-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_date_time-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_filesystem-*-mt-1_*.dll
              ${Boost_LIBRARY_DIRS}/boost_program_options-*-mt-1_*.dll)

     INSTALL (DIRECTORY "${DynaMind-ToolBox_BINARY_DIR}/output/" DESTINATION bin)
     INSTALL (DIRECTORY "C:/winlibs/Python27/" DESTINATION bin)
     INSTALL (DIRECTORY "C:/winlibs/GDAL/" DESTINATION bin)

     INSTALL(FILES ${DLLS} DESTINATION bin)

     FIND_PACKAGE(Qt4 REQUIRED)
     SET(QT_USE_QTSQL true)
     MESSAGE(STATUS "QT PLUGINS DIR: " ${QT_PLUINGS_DIR})


     INSTALL(FILES "${CMAKE_CURRENT_SOURCE_DIR}/qtconf/qt.conf" DESTINATION bin)
     INSTALL(FILES ${QT_PLUINGS_DIR}/sqldrivers/qsqlite4.dll DESTINATION bin/plugins/sqldrivers)

     set(CPACK_PACKAGE_EXECUTABLES "dynamind-gui;DynaMind-Modellbuilder")
     SET(CPACK_NSIS_EXTRA_UNINSTALL_COMMANDS "
        WriteRegStr HKCU \\\"Software\\\\IUT\\\\DYNAMIND\\\" Editra \\\"$INSTDIR\\\\lib\\\\DynaMind\\\\3dparty\\\\Editra\\\\\\\"
        DeleteRegValue \\\${env_hklm} DYNAMIND_DIR
        SendMessage \\\${HWND_BROADCAST} \\\${WM_WININICHANGE} 0 \\\"STR:Environment\\\" /TIMEOUT=5000
        DeleteRegValue \\\${env_hklm} DYNAMIND_PYTHON
        SendMessage \\\${HWND_BROADCAST} \\\${WM_WININICHANGE} 0 \\\"STR:Environment\\\" /TIMEOUT=5000
      ")
ENDIF()
INCLUDE(CPack)
